<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AR Building Viewer ‚Äì Kamera fix</title>

  <!-- DE: iOS-freundliche Versionen -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://unpkg.com/@ar-js-org/ar.js@3.3.2/aframe/build/aframe-ar.js"></script>

  <style>
    /* DE: Transparenter Seitenhintergrund + Canvas ‚Üí Videobild ist sichtbar */
    html,body{margin:0;height:100%;background:transparent;font-family:Arial,system-ui}
    /* DE: Szene anfangs verstecken, bis Kamera erlaubt wurde (verhindert "wei√ües" Canvas) */
    a-scene{display:none}

    #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);color:#fff;z-index:999}
    #overlay .box{padding:24px 28px;border-radius:12px;text-align:center;max-width:480px}
    .btn{display:inline-block;padding:10px 14px;border:0;border-radius:8px;background:#28a745;color:#fff;cursor:pointer;font-size:16px}

    #controls{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.8);color:#fff;
      padding:15px;border-radius:8px;z-index:150;font-size:14px}
    .mode-btn{display:block;width:100%;margin:6px 0;padding:10px;background:#007bff;color:#fff;border:0;border-radius:6px;cursor:pointer}
    .mode-btn:hover{background:#0056b3}.mode-btn.active{background:#28a745}

    #info{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.8);color:#fff;padding:15px;border-radius:8px;z-index:120;font-size:14px;max-width:300px;line-height:1.4}
    #gps-info{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,.8);color:#fff;padding:10px;border-radius:6px;z-index:110;font-size:12px;max-width:280px}
    .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-loading{background:orange}.status-ready{background:green}.status-error{background:red}
    .hidden{display:none!important}
  </style>
</head>
<body>

  <!-- DE: Start-Overlay (User-Geste f√ºr Kamera) -->
  <div id="overlay">
    <div class="box">
      <h3 style="margin:0 0 10px">AR starten</h3>
      <p style="margin:0 0 14px">Tippe auf ‚ÄûKamera erlauben‚Äú. Safari fragt nach Kamera-Zugriff.</p>
      <button id="btnStart" class="btn">Kamera erlauben</button>
      <p id="ovlMsg" style="margin:10px 0 0;opacity:.8;font-size:13px"></p>
    </div>
  </div>

  <!-- DE: Steuerung -->
  <div id="controls">
    <div style="margin-bottom:10px"><strong>Darstellungsmodus</strong></div>
    <button class="mode-btn" id="btn-direct">üì± Direkt vor mir</button>
    <button class="mode-btn" id="btn-gps">üåç GPS-Koordinaten</button>
    <button class="mode-btn" id="btn-coordinates">üìç Koordinaten eingeben</button>
    <button class="mode-btn" id="z-up">Z +0.5 m</button>
    <button class="mode-btn" id="z-down">Z ‚àí0.5 m</button>
  </div>

  <!-- DE: Info/Diagnose -->
  <div id="info">
    <div><span id="status" class="status-indicator status-loading"></span>
      <strong id="mode-title">AR Building Viewer</strong>
    </div>
    <div id="mode-description" style="margin-top:8px">Nach Freigabe sollte das Kamerabild zu sehen sein.</div>
    <div id="distance-info" style="margin-top:8px;font-size:12px;color:#aaa"></div>
  </div>

  <!-- DE: GPS-Infos -->
  <div id="gps-info" class="hidden">
    <div><strong>GPS-Informationen</strong></div>
    <div id="current-position">Deine Position: ‚Äî</div>
    <div id="target-position">Ziel: ‚Äî</div>
    <div id="distance-display">Entfernung: ‚Äî</div>
  </div>

  <!-- DE: Koordinaten-Dialog -->
  <div id="coordinate-modal" style="display:none;position:absolute;top:50%;left:50%;
       transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#fff;
       padding:24px;border-radius:12px;z-index:300">
    <h3 style="margin-top:0">GPS-Koordinaten eingeben</h3>
    <div style="margin:12px 0">
      <label>Breite (Latitude):</label><br>
      <input type="number" id="input-lat" step="any" placeholder="46.8013" style="width:220px;padding:6px;margin-top:6px">
    </div>
    <div style="margin:12px 0">
      <label>L√§nge (Longitude):</label><br>
      <input type="number" id="input-lng" step="any" placeholder="9.8355" style="width:220px;padding:6px;margin-top:6px">
    </div>
    <button id="btn-apply" class="mode-btn" style="width:auto;background:#28a745">√úbernehmen</button>
    <button id="btn-cancel" class="mode-btn" style="width:auto;background:#dc3545">Abbrechen</button>
  </div>

  <!-- DE: AR-Szene ‚Äì wird erst NACH Kamera-Freigabe sichtbar -->
  <a-scene
    id="scene"
    vr-mode-ui="enabled:false"
    renderer="alpha:true;antialias:true;precision:mediump"
    arjs="sourceType: webcam; facingMode: environment; videoTexture: true; debugUIEnabled: false"
    embedded
    style="width:100vw;height:100vh">

    <!-- DE: Assets -->
    <a-assets>
      <a-asset-item id="buildingModel" src="building.glb"></a-asset-item>
    </a-assets>

    <!-- DE: Eine Kamera (gps-new-camera) ‚Üí liefert Videohintergrund -->
    <a-entity id="camRig" gps-new-camera="gpsMinDistance: 5">
      <a-entity camera look-controls="enabled:true"></a-entity>

      <!-- DE: Direktmodus ‚Äì 5 m vor der Kamera -->
      <a-entity id="building-direct"
        gltf-model="#buildingModel"
        position="0 -1 -5"
        scale="0.5 0.5 0.5"
        rotation="0 0 0"
        visible="false">
        <a-text value="Meine Geb√§ude" position="0 3 0" align="center" color="#fff" scale="2 2 2" look-at="[camera]"></a-text>
      </a-entity>
    </a-entity>

    <!-- DE: GPS-Modus ‚Äì platzieren per Lat/Lon -->
    <a-entity id="building-gps"
      gps-new-entity-place="latitude: 46.8013; longitude: 9.8355"
      gltf-model="#buildingModel"
      scale="8 8 8"
      rotation="0 0 0"
      visible="false">
      <a-text value="Davos Building" position="0 12 0" align="center" color="#fff" scale="4 4 4" look-at="[gps-new-camera]"></a-text>
    </a-entity>
  </a-scene>

  <script>
    /* ===================== KONFIG ===================== */
    const START_COORD = { lat:46.8013, lon:9.8355 }; // Davos Beispiel
    let state = { mode:null, lat:START_COORD.lat, lon:START_COORD.lon, z:0, scaleDirect:0.5, scaleGPS:8 };
    /* ================================================== */

    const $ = s => document.querySelector(s);
    const scene = $('#scene'), overlay = $('#overlay'), ovlMsg = $('#ovlMsg');
    const statusDot = $('#status'), modeTitle = $('#mode-title'), modeDesc = $('#mode-description');
    const gpsInfoBox = $('#gps-info'), distInfo = $('#distance-info');
    const buildingDirect = $('#building-direct'), buildingGPS = $('#building-gps');

    // DE: Kamera "warm-up" ‚Äì nach Klick Rechte anfragen, dann Szene anzeigen
    $('#btnStart').onclick = async ()=>{
      try{
        ovlMsg.textContent = 'Kamera wird angefragt ‚Ä¶';
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        // DE: Tracks sofort schlie√üen ‚Äì AR.js bindet gleich sein eigenes <video> an
        s.getTracks().forEach(t=>t.stop());
        overlay.style.display = 'none';
        scene.style.display = 'block'; // DE: jetzt darf A-Frame/AR.js initialisieren
        statusDot.className = 'status-indicator status-ready';
        modeDesc.textContent = 'Kamera OK ‚Äì w√§hle ‚ÄûDirekt‚Äú oder ‚ÄûGPS‚Äú.';
        switchMode('direct'); // DE: direkt starten, damit man Video + Modell sieht
      }catch(e){
        ovlMsg.textContent = 'Kamera verweigert: ' + (e && e.message ? e.message : e);
        statusDot.className = 'status-indicator status-error';
      }
    };

    // DE: Kamera-Diagnostik von AR.js (sollte kurz nach Freigabe feuern)
    window.addEventListener('arjs-video-loaded', ()=> {
      statusDot.className = 'status-indicator status-ready';
      if(!state.mode) modeDesc.textContent = 'Kamera OK ‚Äì w√§hle Modus.';
    });
    window.addEventListener('arjs-video-error', (e)=>{
      const name = e && e.detail && e.detail.error ? (e.detail.error.name || e.detail.error.message) : 'unbekannt';
      statusDot.className = 'status-indicator status-error';
      modeDesc.textContent = 'Kamera-FEHLER: ' + name + ' (Safari-Rechte pr√ºfen).';
    });

    // DE: Moduswechsel
    $('#btn-direct').onclick = ()=> switchMode('direct');
    $('#btn-gps').onclick    = ()=> switchMode('gps');

    function switchMode(mode){
      state.mode = mode;
      document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
      if(mode==='direct') $('#btn-direct').classList.add('active'); else $('#btn-gps').classList.add('active');

      if(mode==='direct'){
        modeTitle.textContent = 'Direkt-AR';
        modeDesc.textContent  = 'Modell 5 m vor der Kamera. Videohintergrund aktiv.';
        buildingDirect.setAttribute('visible', true);
        buildingGPS.setAttribute('visible', false);
        applyZ(); // DE: Z-Offset auf Direkt setzen
        gpsInfoBox.classList.add('hidden');
      }else{
        modeTitle.textContent = 'GPS-AR';
        modeDesc.textContent  = 'Modell an den GPS-Koordinaten. Videohintergrund aktiv.';
        buildingDirect.setAttribute('visible', false);
        buildingGPS.setAttribute('visible', true);
        buildingGPS.setAttribute('gps-new-entity-place', `latitude: ${state.lat}; longitude: ${state.lon}`);
        buildingGPS.setAttribute('position', `0 ${state.z} 0`);
        buildingGPS.setAttribute('scale', `${state.scaleGPS} ${state.scaleGPS} ${state.scaleGPS}`);
        gpsInfoBox.classList.remove('hidden');
        updateGPSDisplay();
        startGPSTracking();
      }
    }

    // DE: Z-Offset (H√∂he) steuern
    $('#z-up').onclick   = ()=>{ state.z += 0.5; applyZ(); };
    $('#z-down').onclick = ()=>{ state.z -= 0.5; applyZ(); };
    function applyZ(){
      if(state.mode==='direct'){
        const p = buildingDirect.getAttribute('position') || {x:0,y:-1,z:-5};
        buildingDirect.setAttribute('position', { x:p.x, y:(-1 + state.z), z:p.z });
      }else{
        buildingGPS.setAttribute('position', `0 ${state.z} 0`);
      }
      modeDesc.textContent = `H√∂hen-Offset Z = ${state.z.toFixed(2)} m`;
    }

    // DE: Koordinaten-Dialog
    $('#btn-coordinates').onclick = ()=>{
      $('#coordinate-modal').style.display='block';
      $('#input-lat').value = state.lat;
      $('#input-lng').value = state.lon;
    };
    $('#btn-cancel').onclick = ()=> $('#coordinate-modal').style.display='none';
    $('#btn-apply').onclick = ()=>{
      const lat = parseFloat($('#input-lat').value);
      const lon = parseFloat($('#input-lng').value);
      if(Number.isNaN(lat)||Number.isNaN(lon)){ alert('Bitte g√ºltige Koordinaten eingeben.'); return; }
      state.lat=lat; state.lon=lon;
      $('#coordinate-modal').style.display='none';
      if(state.mode!=='gps') switchMode('gps');
      else{
        buildingGPS.setAttribute('gps-new-entity-place', `latitude: ${state.lat}; longitude: ${state.lon}`);
        updateGPSDisplay();
      }
    };

    // DE: GPS-Tracking / Anzeige
    let watchId=null, currentPosition=null;
    function startGPSTracking(){
      if(!navigator.geolocation) return;
      if(watchId!==null) return;
      watchId = navigator.geolocation.watchPosition(
        pos=>{
          currentPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
          updateGPSDisplay();
        },
        err=>{
          statusDot.className = 'status-indicator status-error';
          distInfo.textContent = 'GPS nicht verf√ºgbar: ' + err.message;
        },
        { enableHighAccuracy:true, timeout:15000, maximumAge:30000 }
      );
    }
    function updateGPSDisplay(){
      if(currentPosition){
        $('#current-position').textContent = `Deine Position: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lon.toFixed(6)}`;
      }
      $('#target-position').textContent = `Ziel: ${state.lat}, ${state.lon}`;
      if(currentPosition){
        const d = haversine(currentPosition.lat, currentPosition.lon, state.lat, state.lon);
        $('#distance-display').textContent = `Entfernung: ${d.toFixed(0)} m`;
        $('#distance-info').textContent   = `Entfernung: ${d.toFixed(0)} m`;
      }
    }
    function haversine(lat1,lon1,lat2,lon2){
      const R=6371e3, toR=x=>x*Math.PI/180;
      const dœÜ=toR(lat2-lat1), dŒª=toR(lon2-lon1);
      const a=Math.sin(dœÜ/2)**2 + Math.cos(toR(lat1))*Math.cos(toR(lat2))*Math.sin(dŒª/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    // DE: Modell-Ladefeedback
    [buildingDirect, buildingGPS].forEach(el=>{
      el.addEventListener('model-loaded', ()=>{ statusDot.className='status-indicator status-ready'; });
      el.addEventListener('model-error', e=>{
        statusDot.className='status-indicator status-error';
        console.error('GLB Fehler:', e);
        modeDesc.textContent = 'FEHLER: GLB nicht geladen (Pfad/Name pr√ºfen).';
      });
    });
  </script>
</body>
</html>
