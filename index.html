<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AR Building Viewer ‚Äì GPS & Direkt</title>

  <!-- DE: Bew√§hrte, iOS-freundliche Versionen -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <!-- DE: AR.js Location-Based (neuere Komponenten wie gps-new-camera) -->
  <script src="https://unpkg.com/@ar-js-org/ar.js@3.3.2/aframe/build/aframe-ar.js"></script>

  <style>
    body{margin:0;background:#000;font-family:Arial,system-ui}
    #loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:200}
    #loading>div{background:rgba(0,0,0,.9);color:#fff;padding:24px 28px;border-radius:12px;text-align:center}

    #controls{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.8);color:#fff;
      padding:15px;border-radius:8px;z-index:150;font-size:14px}
    .mode-btn{display:block;width:100%;margin:6px 0;padding:10px;background:#007bff;color:#fff;border:0;border-radius:6px;cursor:pointer}
    .mode-btn:hover{background:#0056b3}.mode-btn.active{background:#28a745}

    #info{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.8);color:#fff;padding:15px;border-radius:8px;z-index:120;font-size:14px;max-width:300px;line-height:1.4}
    #gps-info{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,.8);color:#fff;padding:10px;border-radius:6px;z-index:110;font-size:12px;max-width:280px}
    .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-loading{background:orange}.status-ready{background:green}.status-error{background:red}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <!-- DE: Start/Status-Overlay -->
  <div id="loading">
    <div>
      <h3 style="margin:0 0 8px">AR initialisieren</h3>
      <p id="loading-text" style="margin:0 0 12px">Tippe auf ‚ÄûAR starten‚Äú, dann Kamera erlauben.</p>
      <button id="btn-start" class="mode-btn" style="width:auto">AR starten</button>
    </div>
  </div>

  <!-- DE: Steuerung (Moduswahl) -->
  <div id="controls">
    <div style="margin-bottom:10px"><strong>Darstellungsmodus</strong></div>
    <button class="mode-btn" id="btn-direct">üì± Direkt vor mir</button>
    <button class="mode-btn" id="btn-gps">üåç GPS-Koordinaten</button>
    <button class="mode-btn" id="btn-coordinates">üìç Koordinaten eingeben</button>
    <!-- DE: Zusatztasten: H√∂he +/‚àí -->
    <button class="mode-btn" id="z-up">Z +0.5 m</button>
    <button class="mode-btn" id="z-down">Z ‚àí0.5 m</button>
  </div>

  <!-- DE: Info/Diagnose -->
  <div id="info">
    <div><span id="status" class="status-indicator status-loading"></span>
      <strong id="mode-title">AR Building Viewer</strong>
    </div>
    <div id="mode-description" style="margin-top:8px">W√§hle einen Modus und starte AR.</div>
    <div id="distance-info" style="margin-top:8px;font-size:12px;color:#aaa"></div>
  </div>

  <!-- DE: GPS-Infos -->
  <div id="gps-info" class="hidden">
    <div><strong>GPS-Informationen</strong></div>
    <div id="current-position">Deine Position: ‚Äî</div>
    <div id="target-position">Ziel: ‚Äî</div>
    <div id="distance-display">Entfernung: ‚Äî</div>
  </div>

  <!-- DE: Koordinaten-Dialog -->
  <div id="coordinate-modal" style="display:none;position:absolute;top:50%;left:50%;
       transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#fff;
       padding:24px;border-radius:12px;z-index:300">
    <h3 style="margin-top:0">GPS-Koordinaten eingeben</h3>
    <div style="margin:12px 0">
      <label>Breite (Latitude):</label><br>
      <input type="number" id="input-lat" step="any" placeholder="z. B. 46.8013" style="width:220px;padding:6px;margin-top:6px">
    </div>
    <div style="margin:12px 0">
      <label>L√§nge (Longitude):</label><br>
      <input type="number" id="input-lng" step="any" placeholder="z. B. 9.8355" style="width:220px;padding:6px;margin-top:6px">
    </div>
    <button id="btn-apply" class="mode-btn" style="width:auto;background:#28a745">√úbernehmen</button>
    <button id="btn-cancel" class="mode-btn" style="width:auto;background:#dc3545">Abbrechen</button>
  </div>

  <!-- DE: Szene ‚Äì wird nach Start sichtbar genutzt -->
  <a-scene
    id="scene"
    vr-mode-ui="enabled:false"
    arjs="sourceType: webcam; facingMode: environment; videoTexture: true; debugUIEnabled: false"
    renderer="alpha:true;antialias:true;precision:mediump"
    embedded
    style="width:100vw;height:100vh">

    <!-- DE: Assets -->
    <a-assets>
      <!-- DE: ACHTUNG Dateiname: glb (nicht gbl) -->
      <a-asset-item id="buildingModel" src="building.glb"></a-asset-item>
    </a-assets>

    <!-- DE: Direktmodus ‚Äì Modell fest 5 m vor Kamera (sichtbar erst nach Umschaltung) -->
    <a-entity id="building-direct"
      gltf-model="#buildingModel"
      position="0 -1 -5"
      scale="0.5 0.5 0.5"
      rotation="0 0 0"
      visible="false">
      <a-text value="Meine Geb√§ude"
              position="0 3 0" align="center" color="#fff" scale="2 2 2"
              look-at="[camera]"></a-text>
    </a-entity>

    <!-- DE: GPS-Modus ‚Äì Position per Lat/Lon (sichtbar erst nach Umschaltung) -->
    <a-entity id="building-gps"
      gps-new-entity-place="latitude: 46.8013; longitude: 9.8355"
      gltf-model="#buildingModel"
      scale="8 8 8"
      rotation="0 0 0"
      visible="false">
      <a-text value="Davos Building"
              position="0 12 0" align="center" color="#fff" scale="4 4 4"
              look-at="[gps-new-camera]"></a-text>
    </a-entity>

    <!-- DE: Kamera f√ºr Direktmodus -->
    <a-camera id="direct-camera"
      wasd-controls="enabled:true"
      look-controls="enabled:true"
      visible="true"></a-camera>

    <!-- DE: GPS-Kamera (neue Komponente) ‚Äì anfangs verborgen -->
    <a-camera id="gpsCam"
      gps-new-camera="gpsMinDistance: 5"
      wasd-controls="enabled:false"
      look-controls="enabled:true"
      visible="false"></a-camera>
  </a-scene>

  <script>
    /* ===================== KONFIG ===================== */
    // DE: Datei des GLB (wenn anders benannt, hier anpassen)
    const MODEL_URL = 'building.glb';
    // DE: Anfangswerte
    const START_COORD = { lat: 46.8013, lon: 9.8355 }; // Davos (Beispiel)
    let state = {
      mode: null,
      lat: START_COORD.lat, lon: START_COORD.lon,
      z: 0,               // DE: H√∂hen-Offset in Metern (A-Frame Y-Achse)
      scaleDirect: 0.5,   // DE: Direktmodus-Skalierung
      scaleGPS: 8         // DE: GPS-Skalierung
    };
    /* ================================================== */

    // DE: UI/DOM Referenzen
    const $ = s => document.querySelector(s);
    const statusDot = $('#status');
    const modeTitle = $('#mode-title');
    const modeDesc  = $('#mode-description');

    const buildingDirect = $('#building-direct');
    const buildingGPS    = $('#building-gps');
    const directCam      = $('#direct-camera');
    const gpsCam         = $('#gpsCam');

    const gpsInfoBox     = $('#gps-info');
    const distInfo       = $('#distance-info');

    // DE: Start ‚Äì Kamera erst nach User-Geste anfragen (iOS Policy)
    $('#btn-start').onclick = async () => {
      try{
        $('#loading-text').textContent = 'Kamera wird angefragt ‚Ä¶';
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        s.getTracks().forEach(t=>t.stop()); // DE: sofort schlie√üen ‚Äì AR.js √ºbernimmt danach
        statusDot.className = 'status-indicator status-ready';
        $('#loading').classList.add('hidden');
        // DE: Standardm√§√üig Direktmodus w√§hlen
        switchMode('direct');
        modeDesc.textContent = 'Tipp: Wechsle auf ‚ÄûGPS-Koordinaten‚Äú, um die Position zu testen.';
      }catch(e){
        statusDot.className = 'status-indicator status-error';
        $('#loading-text').textContent = 'Kamera verweigert: ' + (e && e.message ? e.message : e);
      }
    };

    // DE: Moduswechsel
    $('#btn-direct').onclick = () => switchMode('direct');
    $('#btn-gps').onclick    = () => switchMode('gps');

    function switchMode(mode){
      state.mode = mode;
      // DE: Buttons aktivieren/markieren
      document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
      if(mode==='direct') $('#btn-direct').classList.add('active'); else $('#btn-gps').classList.add('active');

      if(mode==='direct'){
        modeTitle.textContent = 'Direkt-AR';
        modeDesc.textContent  = 'Modell erscheint fix 5 m vor der Kamera (ohne GPS).';

        // DE: Sichtbarkeit/Steuerung
        buildingDirect.setAttribute('visible', true);
        buildingGPS.setAttribute('visible', false);
        directCam.setAttribute('visible', true);
        gpsCam.setAttribute('visible', false);
        gpsInfoBox.classList.add('hidden');

        // DE: Z-Offset f√ºr Direktmodus anwenden
        const p = buildingDirect.getAttribute('position') || {x:0,y:-1,z:-5};
        buildingDirect.setAttribute('position', { x:p.x, y:(-1 + state.z), z:p.z });
        buildingDirect.setAttribute('scale', `${state.scaleDirect} ${state.scaleDirect} ${state.scaleDirect}`);

      }else{
        modeTitle.textContent = 'GPS-AR';
        modeDesc.textContent  = 'Modell erscheint an den gegebenen GPS-Koordinaten.';
        buildingDirect.setAttribute('visible', false);
        buildingGPS.setAttribute('visible', true);
        directCam.setAttribute('visible', false);
        gpsCam.setAttribute('visible', true);
        gpsInfoBox.classList.remove('hidden');

        // DE: Zielkoordinaten + Z-Offset setzen
        buildingGPS.setAttribute('gps-new-entity-place', `latitude: ${state.lat}; longitude: ${state.lon}`);
        // DE: Z-Offset als lokaler Positions-Offset
        buildingGPS.setAttribute('position', `0 ${state.z} 0`);
        buildingGPS.setAttribute('scale', `${state.scaleGPS} ${state.scaleGPS} ${state.scaleGPS}`);

        updateGPSDisplay();
        startGPSTrackingOnce(); // DE: nur initial ‚Äûwecken‚Äú
      }
    }

    // DE: Z-Offset Tasten
    $('#z-up').onclick   = ()=>{ state.z += 0.5; applyZ(); };
    $('#z-down').onclick = ()=>{ state.z -= 0.5; applyZ(); };
    function applyZ(){
      if(state.mode==='direct'){
        const p = buildingDirect.getAttribute('position') || {x:0,y:-1,z:-5};
        buildingDirect.setAttribute('position', { x:p.x, y:(-1 + state.z), z:p.z });
      }else{
        buildingGPS.setAttribute('position', `0 ${state.z} 0`);
      }
      modeDesc.textContent = `H√∂hen-Offset Z = ${state.z.toFixed(2)} m`;
    }

    // DE: GPS-Tracking (einmal ansto√üen; watchPosition optional)
    let gpsStarted = false;
    function startGPSTrackingOnce(){
      if(gpsStarted || !navigator.geolocation) return;
      gpsStarted = true;
      navigator.geolocation.getCurrentPosition(
        pos=>{
          currentPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
          updateGPSDisplay();
        },
        err=>{
          statusDot.className = 'status-indicator status-error';
          distInfo.textContent = 'GPS nicht verf√ºgbar: ' + err.message;
        },
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
      // DE: Optional: kontinuierliches Tracking einschalten
      navigator.geolocation.watchPosition(
        pos=>{
          currentPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
          updateGPSDisplay();
        },
        ()=>{},
        { enableHighAccuracy:true, timeout:15000, maximumAge:30000 }
      );
    }

    // DE: Koordinaten-Dialog
    $('#btn-coordinates').onclick = ()=>{
      $('#coordinate-modal').style.display = 'block';
      $('#input-lat').value = state.lat;
      $('#input-lng').value = state.lon;
    };
    $('#btn-cancel').onclick = ()=> $('#coordinate-modal').style.display = 'none';
    $('#btn-apply').onclick = ()=> {
      const lat = parseFloat($('#input-lat').value);
      const lon = parseFloat($('#input-lng').value);
      if(Number.isNaN(lat) || Number.isNaN(lon)){ alert('Bitte g√ºltige Koordinaten eingeben.'); return; }
      state.lat = lat; state.lon = lon;
      $('#coordinate-modal').style.display = 'none';
      if(state.mode!=='gps') switchMode('gps');
      else {
        buildingGPS.setAttribute('gps-new-entity-place', `latitude: ${state.lat}; longitude: ${state.lon}`);
        updateGPSDisplay();
      }
    };

    // DE: GPS-Anzeige + Entfernung
    let currentPosition = null;
    function updateGPSDisplay(){
      if(currentPosition){
        $('#current-position').textContent = `Deine Position: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lon.toFixed(6)}`;
      }
      $('#target-position').textContent = `Ziel: ${state.lat}, ${state.lon}`;
      if(currentPosition){
        const d = haversine(currentPosition.lat, currentPosition.lon, state.lat, state.lon);
        $('#distance-display').textContent = `Entfernung: ${d.toFixed(0)} m`;
        distInfo.textContent = `Entfernung: ${d.toFixed(0)} m`;
      }
    }

    // DE: Haversine-Distanz (Meter)
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371e3, toRad=x=>x*Math.PI/180;
      const dœÜ = toRad(lat2-lat1), dŒª = toRad(lon2-lon1);
      const a = Math.sin(dœÜ/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dŒª/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // DE: Modell-Diagnostik
    function hookModelEvents(){
      [buildingDirect, buildingGPS].forEach(el=>{
        el.addEventListener('model-loaded', ()=>{
          statusDot.className = 'status-indicator status-ready';
          modeDesc.textContent = 'Modell geladen. Falls unsichtbar: Gr√∂√üe/Z-Offset anpassen und umsehen.';
        });
        el.addEventListener('model-error', (e)=>{
          statusDot.className = 'status-indicator status-error';
          modeDesc.textContent = 'FEHLER: Konnte GLB nicht laden (Pfad/Name pr√ºfen).';
          console.error('GLB Fehler:', e);
        });
      });
    }
    hookModelEvents();

    // DE: Kamera-Diagnostik aus AR.js
    window.addEventListener('arjs-video-loaded', ()=> {
      statusDot.className = 'status-indicator status-ready';
      if(state.mode==='gps') modeDesc.textContent = 'Kamera OK ‚Äì GPS platzieren & ggf. Z/Gr√∂√üe justieren.';
    });
    window.addEventListener('arjs-video-error', (e)=>{
      statusDot.className = 'status-indicator status-error';
      const name = e && e.detail && e.detail.error ? (e.detail.error.name || e.detail.error.message) : 'unbekannt';
      modeDesc.textContent = 'Kamera-FEHLER: ' + name + ' (Safari Rechte pr√ºfen).';
    });
  </script>
</body>
</html>
