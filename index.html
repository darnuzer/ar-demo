<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AR Building Viewer ‚Äì Kamera-Background + GPS + Scale & Distanz</title>

<!-- A-Frame + AR.js (Location Based) -->
<script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
<script src="https://unpkg.com/@ar-js-org/ar.js@3.3.2/aframe/build/aframe-ar.js"></script>

<style>
  /* DE: Eigenes Kameravideo liegt HINTER der AR-Szene */
  html,body{margin:0;height:100%;background:#000;font-family:Arial,system-ui}
  #bgVideo{position:fixed;inset:0;object-fit:cover;width:100vw;height:100vh;z-index:0;background:#000;display:none}
  a-scene{position:fixed;inset:0;z-index:1} /* AR-Canvas √ºber Video */

  /* UI */
  #loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);color:#fff;z-index:999}
  #loading .box{padding:24px 28px;border-radius:12px;text-align:center;max-width:480px}
  .btn{display:inline-block;padding:10px 14px;border:0;border-radius:8px;background:#28a745;color:#fff;cursor:pointer;font-size:16px}

  #controls{position:fixed;top:10px;right:10px;background:rgba(0,0,0,.8);color:#fff;padding:15px;border-radius:8px;z-index:150;font-size:14px;max-width:240px}
  .mode-btn{display:block;width:100%;margin:6px 0;padding:10px;background:#007bff;color:#fff;border:0;border-radius:6px;cursor:pointer}
  .mode-btn:hover{background:#0056b3}.mode-btn.active{background:#28a745}

  #info{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.8);color:#fff;padding:12px;border-radius:8px;z-index:120;font-size:14px;max-width:340px}
  .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
  .status-ready{background:green}.status-error{background:red}.status-loading{background:orange}

  #gps-info{position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,.8);color:#fff;padding:10px;border-radius:6px;z-index:110;font-size:12px;max-width:340px}
  .hidden{display:none!important}

  /* Koordinaten-Dialog */
  #coordinate-modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.9);color:#fff;padding:24px;border-radius:12px;z-index:300}
  #coordinate-modal input{width:220px;padding:6px;margin-top:6px}
</style>
</head>
<body>

<!-- DE: Unser eigenes Kameravideo (Hintergrund) -->
<video id="bgVideo" autoplay playsinline muted></video>

<!-- Start/Status Overlay -->
<div id="loading">
  <div class="box">
    <h3 style="margin:0 0 10px">AR starten</h3>
    <p style="margin:0 0 14px">Tippe ‚ÄûKamera erlauben‚Äú. Danach siehst du das Livebild mit AR-Modell.</p>
    <button id="btnStart" class="btn">Kamera erlauben</button>
    <p id="ovlMsg" style="margin:10px 0 0;opacity:.85;font-size:13px"></p>
  </div>
</div>

<!-- Ovl√°dac√≠ panel -->
<div id="controls">
  <div style="margin-bottom:10px"><strong>Darstellungsmodus</strong></div>
  <button class="mode-btn" id="btn-direct">üì± Direkt vor mir</button>
  <button class="mode-btn" id="btn-gps">üåç GPS-Koordinaten</button>
  <button class="mode-btn" id="btn-coordinates">üìç Koordinaten eingeben</button>

  <div style="margin:12px 0 6px"><strong>H√∂he / Gr√∂√üe</strong></div>
  <button class="mode-btn" id="z-up">Z +0.5 m</button>
  <button class="mode-btn" id="z-down">Z ‚àí0.5 m</button>
  <button class="mode-btn" id="scale-up">Gr√∂√üe +10%</button>
  <button class="mode-btn" id="scale-down">Gr√∂√üe ‚àí10%</button>

  <div style="margin:12px 0 6px"><strong>Distanz (Direkt)</strong></div>
  <button class="mode-btn" id="dist-farther">Weiter weg (+1 m)</button>
  <button class="mode-btn" id="dist-closer">N√§her ran (‚àí1 m)</button>
</div>

<!-- Info panel -->
<div id="info">
  <div><span id="statusDot" class="status-indicator status-loading"></span>
       <span id="msg">Bereit zum Starten.</span></div>
  <div id="scaleInfo" style="margin-top:6px;opacity:.9"></div>
  <div id="distInfo" style="margin-top:6px;opacity:.9"></div>
  <div id="directSettings" style="margin-top:6px;opacity:.9"></div>
</div>

<!-- GPS informace -->
<div id="gps-info" class="hidden">
  <div><strong>GPS-Informationen</strong></div>
  <div id="current-position">Deine Position: ‚Äî</div>
  <div id="target-position">Ziel: ‚Äî</div>
  <div id="distance-display">Entfernung (horizontal): ‚Äî</div>
  <div id="distance-3d">Entfernung (3D, inkl. Z): ‚Äî</div>
</div>

<!-- Dialog pro zad√°n√≠ sou≈ôadnic -->
<div id="coordinate-modal">
  <h3 style="margin-top:0">GPS-Koordinaten eingeben</h3>
  <div style="margin:12px 0">
    <label>Breite (Latitude):</label><br>
    <input type="number" id="input-lat" step="any" placeholder="46.8013">
  </div>
  <div style="margin:12px 0">
    <label>L√§nge (Longitude):</label><br>
    <input type="number" id="input-lng" step="any" placeholder="9.8355">
  </div>
  <button id="btn-apply" class="mode-btn" style="width:auto;background:#28a745">√úbernehmen</button>
  <button id="btn-cancel" class="mode-btn" style="width:auto;background:#dc3545">Abbrechen</button>
</div>

<!-- AR-Sc√©na s transparentn√≠m canvasem (AR.js jen pro GPS/Orientation) -->
<a-scene
  vr-mode-ui="enabled:false"
  renderer="alpha:true;antialias:true;precision:mediump"
  arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
  embedded
  style="width:100vw;height:100vh">

  <a-assets>
    <a-asset-item id="buildingModel" src="building.glb"></a-asset-item>
  </a-assets>

  <!-- DE: Eine Kamera mit GPS/Kompass (liefert Pose), Video zeigen wir selbst -->
  <a-entity id="camRig" gps-new-camera="gpsMinDistance: 5">
    <a-entity id="cam" camera look-controls="enabled:true"></a-entity>

    <!-- DE: Direktmodus ‚Äì vor der Kamera, Distanz/Z/Scale werden per JS angepasst -->
    <a-entity id="building-direct"
      gltf-model="#buildingModel"
      position="0 -1 -5"
      scale="0.5 0.5 0.5"
      rotation="0 0 0"
      visible="false">
    </a-entity>
  </a-entity>

  <!-- DE: GPS-Modus ‚Äì Modell an Lat/Lon (H√∂he via position.y in Metern) -->
  <a-entity id="building-gps"
    gps-new-entity-place="latitude: 46.8013; longitude: 9.8355"
    position="0 0 0"
    gltf-model="#buildingModel"
    scale="8 8 8"
    rotation="0 0 0"
    visible="false">
  </a-entity>
</a-scene>

<script>
/* ===================== KONFIG ===================== */
const MODEL_URL   = 'building.glb';          // DE: Datei im selben Ordner
const START_COORD = { lat:46.8013, lon:9.8355 }; // Davos Beispiel
let state = {
  mode:null,
  lat:START_COORD.lat, lon:START_COORD.lon,
  z:0,
  scaleDirect:0.5,   // Startskalierung Direkt
  scaleGPS:8,        // Startskalierung GPS
  distDirect:5       // Startabstand in Metern (Direktmodus)
};
/* ================================================== */

const $ = s=>document.querySelector(s);
const bgVideo = $('#bgVideo'), overlay = $('#loading'), ovlMsg = $('#ovlMsg');
const statusDot = $('#statusDot'), msg = $('#msg');
const scaleInfo = $('#scaleInfo'), distInfo = $('#distInfo'), directSettings = $('#directSettings');
const buildingDirect = $('#building-direct'), buildingGPS = $('#building-gps');
const cam = document.getElementById('cam');
const gpsBox = $('#gps-info');

let currentPosition=null, watchId=null, distTimer=null;

/* ========== 1) Kamera sicher starten (eigenes <video>) ========== */
$('#btnStart').onclick = async ()=>{
  try{
    ovlMsg.textContent = 'Kamera wird angefragt ‚Ä¶';
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' } }, audio:false
    });
    bgVideo.srcObject = stream;
    bgVideo.style.display = 'block';
    overlay.style.display = 'none';
    statusDot.className = 'status-indicator status-ready';
    msg.textContent = 'Kamera OK ‚Äì w√§hle ‚ÄûDirekt‚Äú oder ‚ÄûGPS‚Äú.';
    switchMode('direct'); // Start mit Direktmodus
  }catch(e){
    statusDot.className = 'status-indicator status-error';
    ovlMsg.textContent = 'Kamera verweigert: ' + (e && e.message ? e.message : e);
  }
};

/* ========== 2) Moduswahl, Z-Offset, Skalierung, DISTANZ ========== */
$('#btn-direct').onclick = ()=> switchMode('direct');
$('#btn-gps').onclick    = ()=> switchMode('gps');

$('#z-up').onclick       = ()=> { state.z += 0.5; applyZ(); };
$('#z-down').onclick     = ()=> { state.z -= 0.5; applyZ(); };

$('#scale-up').onclick   = ()=> { changeScale(1.1); };
$('#scale-down').onclick = ()=> { changeScale(1/1.1); };

$('#dist-farther').onclick = ()=>{ state.distDirect = Math.min(200, state.distDirect + 1); applyDistance(); };
$('#dist-closer').onclick  = ()=>{ state.distDirect = Math.max(1,   state.distDirect - 1); applyDistance(); };

function switchMode(mode){
  state.mode = mode;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  clearInterval(distTimer);

  if(mode==='direct'){
    $('#btn-direct').classList.add('active');
    buildingDirect.setAttribute('visible',true);
    buildingGPS.setAttribute('visible',false);
    gpsBox.classList.add('hidden');

    applyDistance(); // setzt auch Z
    applyScale();

    msg.textContent = 'Direktmodus aktiv ‚Äì Modell vor der Kamera.';
    distTimer = setInterval(updateDirectDistance, 300);
    updateDirectDistance();
  }else{
    $('#btn-gps').classList.add('active');
    buildingDirect.setAttribute('visible',false);
    buildingGPS.setAttribute('visible',true);
    buildingGPS.setAttribute('gltf-model', `url(${MODEL_URL}?v=${Date.now()})`); // Cache-Buster
    buildingGPS.setAttribute('gps-new-entity-place', `latitude: ${state.lat}; longitude: ${state.lon}`);

    applyZ();
    applyScale();

    gpsBox.classList.remove('hidden');
    updateGPSDisplay(); startGPSTracking();
    distTimer = setInterval(updateGPS3DDistance, 500);
    updateGPS3DDistance();
    msg.textContent = 'GPS-Modus aktiv ‚Äì Modell an Zielkoordinaten.';
  }
}

/* --- Z (H√∂he) --- */
function applyZ(){
  if(state.mode==='direct'){
    // Y = -1 Basis (damit es ‚Äûauf dem Boden‚Äú wirkt) + Z-Offset
    const y = -1 + state.z;
    buildingDirect.setAttribute('position', `0 ${y} -${state.distDirect}`);
  }else{
    buildingGPS.setAttribute('position', `0 ${state.z} 0`);
  }
  showDirectSettings();
  msg.textContent = `Z-Offset: ${state.z.toFixed(2)} m`;
}

/* --- Distanz (nur Direktmodus) --- */
function applyDistance(){
  if(state.mode==='direct'){
    const y = -1 + state.z;
    buildingDirect.setAttribute('position', `0 ${y} -${state.distDirect}`);
    showDirectSettings();
  }
}
function showDirectSettings(){
  if(state.mode==='direct'){
    directSettings.textContent = `Direkt: Distanz = ${state.distDirect.toFixed(1)} m, Z = ${state.z.toFixed(2)} m`;
  }else{
    directSettings.textContent = '';
  }
}

/* --- Skalierung --- */
function changeScale(factor){
  if(state.mode==='direct'){
    state.scaleDirect = Math.min(1e6, Math.max(1e-6, state.scaleDirect * factor));
  }else{
    state.scaleGPS    = Math.min(1e6, Math.max(1e-6, state.scaleGPS    * factor));
  }
  applyScale();
}
function applyScale(){
  if(state.mode==='direct'){
    const s = state.scaleDirect;
    buildingDirect.setAttribute('scale', `${s} ${s} ${s}`);
    scaleInfo.textContent = `Skalierung (Direkt): √ó${s.toFixed(2)}`;
  }else{
    const s = state.scaleGPS;
    buildingGPS.setAttribute('scale', `${s} ${s} ${s}`);
    scaleInfo.textContent = `Skalierung (GPS): √ó${s.toFixed(2)}`;
  }
}

/* ========== 3) Koordinaten-Dialog ========== */
$('#btn-coordinates').onclick = ()=>{
  $('#coordinate-modal').style.display='block';
  $('#input-lat').value = state.lat;
  $('#input-lng').value = state.lon;
};
$('#btn-cancel').onclick = ()=> $('#coordinate-modal').style.display='none';
$('#btn-apply').onclick = ()=>{
  const lat = parseFloat($('#input-lat').value);
  const lon = parseFloat($('#input-lng').value);
  if(Number.isNaN(lat)||Number.isNaN(lon)){ alert('Bitte g√ºltige Koordinaten eingeben.'); return; }
  state.lat=lat; state.lon=lon;
  $('#coordinate-modal').style.display='none';
  if(state.mode!=='gps') switchMode('gps');
  else{
    buildingGPS.setAttribute('gps-new-entity-place', `latitude: ${state.lat}; longitude: ${state.lon}`);
    updateGPSDisplay(); updateGPS3DDistance();
  }
};

/* ========== 4) GPS-Tracking / Anzeige ========== */
function startGPSTracking(){
  if(!navigator.geolocation) return;
  if(watchId!==null) return;
  watchId = navigator.geolocation.watchPosition(
    pos=>{
      currentPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      updateGPSDisplay(); updateGPS3DDistance();
    },
    err=>{
      statusDot.className = 'status-indicator status-error';
      $('#distance-display').textContent = 'GPS nicht verf√ºgbar: ' + err.message;
      $('#distance-3d').textContent = '';
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:30000 }
  );
}
function updateGPSDisplay(){
  if(currentPosition){
    $('#current-position').textContent = `Deine Position: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lon.toFixed(6)}`;
  }
  $('#target-position').textContent = `Ziel: ${state.lat}, ${state.lon}`;
  if(currentPosition){
    const d = haversine(currentPosition.lat, currentPosition.lon, state.lat, state.lon);
    $('#distance-display').textContent = `Entfernung (horizontal): ${d.toFixed(0)} m`;
  }
}
function updateGPS3DDistance(){
  if(!currentPosition) return;
  const dH = haversine(currentPosition.lat, currentPosition.lon, state.lat, state.lon); // horizontal
  const dZ = Math.abs(state.z); // vertikaler Offset (Meter)
  const d3 = Math.sqrt(dH*dH + dZ*dZ);
  $('#distance-3d').textContent = `Entfernung (3D inkl. Z): ${d3.toFixed(0)} m (Z=${dZ.toFixed(2)} m)`;
}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371e3,toR=x=>x*Math.PI/180;
  const dœÜ=toR(lat2-lat1), dŒª=toR(lon2-lon1);
  const a=Math.sin(dœÜ/2)**2 + Math.cos(toR(lat1))*Math.cos(toR(lat2))*Math.sin(dŒª/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ========== 5) Distanz im Direktmodus (3D) ========== */
function updateDirectDistance(){
  try{
    const camObj = cam.object3D;
    const mdlObj = buildingDirect.object3D;
    if(!camObj || !mdlObj) return;

    const camPos = new THREE.Vector3(); camObj.getWorldPosition(camPos);
    const mdlPos = new THREE.Vector3(); mdlObj.getWorldPosition(mdlPos);
    const dist = camPos.distanceTo(mdlPos); // Meter (A-Frame-Einheiten)
    distInfo.textContent = `Entfernung (Direkt, 3D): ${dist.toFixed(2)} m`;
  }catch(e){
    /* Ignorierbare Race-Conditions beim ersten Frame */
  }
}

/* ========== 6) Model-Diagnostik ========== */
[buildingDirect, buildingGPS].forEach(el=>{
  el.addEventListener('model-loaded', ()=>{ statusDot.className='status-indicator status-ready'; });
  el.addEventListener('model-error',  e=>{ statusDot.className='status-indicator status-error'; console.error('GLB Fehler:',e); msg.textContent='FEHLER: GLB nicht geladen.'; });
});

/* ========== 7) AR.js Kamera-Events (informativ) ========== */
window.addEventListener('arjs-video-loaded', ()=>{ /* wir nutzen unser eigenes Video */ });
window.addEventListener('arjs-video-error',  e=>{ console.warn('AR.js Video-Fehler (ignorierbar, da eigenes Video):', e); });
</script>
</body>
</html>
